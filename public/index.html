<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบประวัตินักศึกษา - เข้าสู่ระบบ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

    <div class="bg-shape shape-1"></div>
    <div class="bg-shape shape-2"></div>

    <div class="container auth-wrapper">
        <div class="glass-container auth-box p-0">
            <!-- Banner Image -->
            <div class="text-center bg-white" style="border-radius: 20px 20px 0 0; overflow: hidden;">
                <img src="img/banner.jpg" alt="Banner" class="img-fluid" style="width: 100%; height: 180px; object-fit: cover;">
            </div>
            
            <div class="text-center mt-3">
                 <img src="img/TClogo.png" alt="Logo" style="width: 80px; height: 80px;">
                 <h2 class="mt-2 text-dark font-weight-bold">ระบบประวัตินักศึกษา</h2>
                 <button class="btn btn-info text-white rounded-pill mt-3 px-4 py-2 shadow-sm font-weight-bold" onclick="openStatsModal()">
                    <i class="bi bi-pie-chart-fill me-2"></i> ดูสถิตินักศึกษา
                 </button>
            </div>
            
            <div class="p-4">
                <ul class="nav nav-pills mb-3 justify-content-center" id="pills-tab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="pills-student-tab" data-bs-toggle="pill" data-bs-target="#pills-student" type="button" role="tab" aria-selected="true">นักเรียน / นักศึกษา</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="pills-admin-tab" data-bs-toggle="pill" data-bs-target="#pills-admin" type="button" role="tab" aria-selected="false">ผู้ดูแลระบบ</button>
                    </li>
                </ul>
                
                <div class="tab-content" id="pills-tabContent">
                    <!-- Student Login -->
                    <div class="tab-pane fade show active" id="pills-student" role="tabpanel">
                        <form id="studentLoginForm">
                            <div class="mb-3">
                                <label class="form-label">รหัสนักศึกษา (Student ID)</label>
                                <input type="text" class="form-control" name="student_code" placeholder="เช่น 6831909xxxx" required oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">รหัสผ่าน (วันเดือนปีเกิด DD/MM/YYYY)</label>
                                <div class="position-relative">
                                    <input type="password" class="form-control" name="password" id="studentPassword" placeholder="เช่น 01/01/2550 (ปี พ.ศ.)" required style="padding-right: 40px;">
                                    <span class="position-absolute top-50 end-0 translate-middle-y me-3" onclick="togglePassword('studentPassword', 'toggleIconStudent')" style="cursor: pointer;">
                                        <i class="bi bi-eye" id="toggleIconStudent"></i>
                                    </span>
                                </div>
                            </div>
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary">เข้าสู่ระบบ</button>
                                <a href="register.html" class="btn btn-outline-light text-dark">ลงทะเบียนนักศึกษาใหม่</a>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Admin Login -->
                    <div class="tab-pane fade" id="pills-admin" role="tabpanel">
                        <form id="adminLoginForm">
                            <div class="mb-3">
                                <label class="form-label">ชื่อผู้ใช้ (Username)</label>
                                <input type="text" class="form-control" name="username" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">รหัสผ่าน (Password)</label>
                                <div class="position-relative">
                                    <input type="password" class="form-control" name="password" id="adminPassword" required style="padding-right: 40px;">
                                    <span class="position-absolute top-50 end-0 translate-middle-y me-3" onclick="togglePassword('adminPassword', 'toggleIconAdmin')" style="cursor: pointer;">
                                        <i class="bi bi-eye" id="toggleIconAdmin"></i>
                                    </span>
                                </div>
                            </div>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary">เข้าสู่ระบบ Admin</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
            </div>
        </div>
    </div>

    <!-- Stats Modal -->
    <div class="modal fade" id="statsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content glass-card border-0">
                <div class="modal-header border-0">
                    <h5 class="modal-title"><i class="bi bi-pie-chart"></i> สถิติจำนวนนักศึกษา</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-7">
                            <canvas id="studentChart"></canvas>
                        </div>
                        <div class="col-md-5 d-flex flex-column justify-content-center">
                            <h4 class="text-center mb-4">จำนวนนักศึกษาทั้งหมด <span id="chartTotalUser" class="text-primary fw-bold"></span> คน</h4>
                            <ul id="chartLegend" class="list-group list-group-flush bg-transparent">
                                <!-- Legend -->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/main.js"></script>
    <script>
        let statsModal;
        let studentChartInstance = null;
        
        document.addEventListener('DOMContentLoaded', () => {
             statsModal = new bootstrap.Modal(document.getElementById('statsModal'));
        });

        function openStatsModal() {
            fetch('/api/auth/public-stats').then(res => res.json()).then(data => {
                if(data.error) return;
                
                document.getElementById('chartTotalUser').innerText = data.students;
                statsModal.show();
                renderChart(data.breakdown);
            });
        }

        function renderChart(data) {
            const ctx = document.getElementById('studentChart').getContext('2d');
            const labels = data.map(d => d.department_name);
            const counts = data.map(d => d.count);
            
            // Department Color Mapping
            const deptColors = {
                "เทคโนโลยีคอมพิวเตอร์": "#FFFFFF",   // white
                "อิเล็กทรอนิกส์": "#04F0F9",        // Light Blue
                "ช่างไฟฟ้ากำลัง": "#FFDE59",        // Yellow
                "เทคโนโลยีสารสนเทศ": "#CECECE",    // Gray
                "ช่างโยธา": "#E8E8E8",             // light gray
                "ช่างก่อสร้าง": "#8D6F64",          // Brown
                "ช่างเชื่อม": "#50873B",           // Green
                "ช่างเมคคาทรอนิกส์": "#964CAB",     // Drak purple
                "ช่างยนต์": "#E4080A",              // red
                "ช่างกลโรงงาน": "#D20103"     // dark red
            };
            
            // Fallback color generator
            const defaultColors = [
                '#4DC9F6', '#F67019', '#F53794', '#537BC4', '#ACC236', '#166A8F', '#00A950', '#58595B', '#8549BA'
            ];

            // Map data to colors based on department name
            const backgroundColors = data.map((d, i) => {
                return deptColors[d.department_name] || defaultColors[i % defaultColors.length];
            });

            // Render Legend
            const legendHtml = data.map((d, i) => {
                const color = deptColors[d.department_name] || defaultColors[i % defaultColors.length];
                return `
                <li class="list-group-item bg-transparent d-flex justify-content-between align-items-center">
                    <span><span style="display:inline-block;width:12px;height:12px;background-color:${color};margin-right:8px;border-radius:50%;"></span>${d.department_name}</span>
                    <span class="badge bg-light text-dark rounded-pill">${d.count}</span>
                </li>
            `}).join('');
            document.getElementById('chartLegend').innerHTML = legendHtml;

            if (studentChartInstance) {
                studentChartInstance.destroy();
            }

            studentChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: counts,
                        backgroundColor: backgroundColors,
                        borderColor: '#000000',
                        borderWidth: 2,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false // We use custom legend
                        }
                    }
                }
            });
        }

        function togglePassword(inputId, iconId) {
            const input = document.getElementById(inputId);
            const icon = document.getElementById(iconId);
            
            if (input.type === "password") {
                input.type = "text";
                icon.classList.remove("bi-eye");
                icon.classList.add("bi-eye-slash");
            } else {
                input.type = "password";
                icon.classList.remove("bi-eye-slash");
                icon.classList.add("bi-eye");
            }
        }

        document.getElementById('studentLoginForm').addEventListener('submit', (e) => {
            handleFormSubmit(e, '/api/auth/login/student');
        });
        document.getElementById('adminLoginForm').addEventListener('submit', (e) => {
            handleFormSubmit(e, '/api/auth/login/admin');
        });
    </script>
</body>
</html>
