<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แดชบอร์ดนักศึกษา</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Wave Background -->
    <div class="wave-container">
        <svg class="wave-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320" preserveAspectRatio="none">
            <path fill="#ffffff" d="M0,160 C360,260 720,60 1080,160 C1260,210 1350,180 1440,160 L1440,320 L0,320 Z"></path>
        </svg>
    </div>

    <div class="bg-shape shape-1"></div>
    <div class="bg-shape shape-2"></div>

    <nav class="navbar navbar-expand-lg glass-nav mb-4">
        <div class="container">
            <a class="navbar-brand fw-bold" href="#">ระบบนักศึกษา</a>
            <div class="d-flex">
                <span class="navbar-text me-3" id="userNameDisplay">ยินดีต้อนรับ</span>
                <button class="btn btn-outline-danger btn-sm" onclick="handleLogout()">ออกจากระบบ</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="row">
            <div class="col-md-4 mb-4">
                <div class="glass-card">
                    <h4 class="mb-3">ข้อมูลส่วนตัว</h4>
                    <div id="studentInfo">
                        <p class="text-center">กำลังโหลด...</p>
                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <div class="glass-card">
                    <h4 class="mb-3">ประกาศ / กิจกรรม</h4>
                    <div id="announcementList">
                        <p class="text-center text-muted">ไม่มีประกาศ</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/main.js"></script>
    <script>
        function handleLogout() {
            fetch('/api/auth/logout', { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if(data.success) window.location.href = 'index.html';
                });
        }

        fetch('/api/student/info')
            .then(res => {
                if(res.status === 401) window.location.href = 'index.html';
                return res.json();
            })
            .then(data => {
                const infoDiv = document.getElementById('studentInfo');
                document.getElementById('userNameDisplay').textContent = `${data.first_name} ${data.last_name}`;
                
                // Format DOB to BE
                const [y, m, d] = data.dob.split('-');
                const beYear = parseInt(y) + 543;
                const dobFormatted = `${d}/${m}/${beYear}`;

                infoDiv.innerHTML = `
                    <div class="text-center mb-3">
                        <img src="${data.student_image || 'img/placeholder.png'}" class="rounded-circle shadow" style="width: 150px; height: 150px; object-fit: cover;">
                    </div>
                    <p><strong>รหัสนักศึกษา:</strong> ${data.student_code}</p>
                    <p><strong>ชื่อ-นามสกุล:</strong> ${data.prefix} ${data.first_name} ${data.last_name}</p>
                    <p><strong>ระดับชั้น:</strong> ${data.level || '-'}</p>
                    <p><strong>แผนกวิชา:</strong> ${data.department_name} (${data.dept_code})</p>
                    <p><strong>วันเกิด:</strong> ${dobFormatted}</p>
                    <p><strong>กรุ๊ปเลือด:</strong> ${data.blood_group || '-'}</p>
                    <p><strong>เบอร์โทรศัพท์:</strong> ${data.phone}</p>
                    <hr>
                    <p class="text-muted mb-2"><strong>ข้อมูลผู้ปกครอง</strong></p>
                    <p><strong>บิดา:</strong> ${data.father_name || '-'}</p>
                    <p><strong>มารดา:</strong> ${data.mother_name || '-'}</p>
                    <p><strong>เบอร์ผู้ปกครอง:</strong> ${data.parent_phone || '-'}</p>
                `;
            });

        // Load Announcements
        fetch('/api/student/announcements')
            .then(res => res.json())
            .then(data => {
                const list = document.getElementById('announcementList');
                if (data.length > 0) {
                    list.innerHTML = data.map(item => `
                        <div class="card mb-3 bg-light border-0 shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title text-primary">${item.title}</h5>
                                ${item.image ? `<img src="${item.image}" class="img-fluid rounded mb-3" style="max-height: 300px;">` : ''}
                                <p class="card-text">${item.content}</p>
                                <p class="card-text"><small class="text-muted"><i class="bi bi-clock"></i> ${new Date(item.created_at).toLocaleString('th-TH')}</small></p>
                            </div>
                        </div>
                    `).join('');
                } else {
                    list.innerHTML = `<p class="text-center text-muted mt-3">ยังไม่มีประกาศสำหรับแผนกของคุณ</p>`;
                }
            });
    </script>
</body>
</html>
